<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Ball Library</ion-title>
    <ion-buttons slot="start">
      <ion-button [href]="storageService.url">
        <div class="powered-by">powered by</div>
        <img
          [src]="storageService.url + '/sites/default/files/logo/bowwwl-logo.svg'"
          alt="bowwwl"
          title="bowwwl.com"
          style="height: 1.5rem; min-width: 80px" />
      </ion-button>
    </ion-buttons>
    <ion-buttons slot="end" class="action-sheet">
      <app-sort-header
        #sortHeader
        [id]="'ball-sort-header'"
        [sortOptions]="sortService.BALL_SORT_OPTIONS"
        [selectedSort]="currentSortOption"
        [storageKey]="'balls-sort-option'"
        [favoritesFirst]="favoritesFirst()"
        [favoritesFirstStorageKey]="'balls-favorites-first'"
        (sortChanged)="onSortChanged($event)"
        (favoritesFirstChanged)="onFavoritesFirstChange($event)">
      </app-sort-header>
      <ion-button fill="clear" (click)="openFilterModal()">
        <ion-icon slot="icon-only" name="filter-outline"></ion-icon>
        <ion-text class="filter-indicator" *ngIf="isFilterActive()">{{ ballFilterService.activeFilterCount() }}</ion-text>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
  <ion-toolbar>
    <ion-searchbar
      appSearchBlur
      [value]="searchTerm()"
      (ionInput)="searchBalls($event)"
      placeholder="Search for a ball"
      showCancelButton="focus"
      debounce="300"></ion-searchbar>
  </ion-toolbar>
  <ion-toolbar style="text-align: center" *ngIf="ballFilterService.activeFilterCount() !== 0">
    <app-generic-filter-active [filters]="currentFilters" [defaultFilters]="defaultFilters" [filterConfigs]="ballFilterConfigs">
    </app-generic-filter-active>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" role="feed">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  @if (!isPageLoading()) {
    <ng-container *ngIf="displayedBalls.length <= 0; else content">
      <ion-text class="no-game-text"> No balls found. </ion-text>
    </ng-container>

    <ng-template #content>
      @for (ball of displayedBalls; track ball.ball_id) {
        <app-ball-swipe-card
          [ball]="ball"
          [inArsenal]="isInArsenal(ball)"
          (similarMovement)="getSimilarMovementBalls($event)"
          (similarCore)="getSameCoreBalls($event)"
          (similarCoverstock)="getSameCoverstockBalls($event)"
          (favoriteToggle)="toggleFavorite($event.event, $event.ball)"
          (addToArsenal)="saveBallToArsenal($event)"
          (removeFromArsenal)="removeFromArsenal($event)">
        </app-ball-swipe-card>
      }
      <!-- Infinite Scroll -->
      <ion-infinite-scroll threshold="100px" (ionInfinite)="loadBalls($event)" *ngIf="hasMoreData">
        <ion-infinite-scroll-content loadingSpinner="crescent" loadingText="Loading more balls..."></ion-infinite-scroll-content>
      </ion-infinite-scroll>
    </ng-template>
  } @else {
    @for (item of [1, 2, 3, 4, 5, 6, 7, 8]; track item) {
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-skeleton-text [animated]="true" style="width: 80%; height: 20px; border-radius: 10px"></ion-skeleton-text>
          </ion-card-title>
          <ion-card-subtitle>
            <ion-skeleton-text [animated]="true" style="width: 50%; border-radius: 10px"></ion-skeleton-text>
          </ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>
          <ion-skeleton-text [animated]="true" style="height: 15vh; width: 15vh; border-radius: 100%; margin: 0 auto"></ion-skeleton-text>
          <div class="ball-info">
            <ion-list lines="none" class="list">
              <div class="core">
                <ion-skeleton-text [animated]="true" style="height: 20px; width: 120px; border-radius: 10px"></ion-skeleton-text>
              </div>
              <ion-skeleton-text [animated]="true" style="height: 17px; width: 100px; border-radius: 10px"></ion-skeleton-text>
              <ion-skeleton-text [animated]="true" style="height: 17px; width: 100px; border-radius: 10px"></ion-skeleton-text>
              <ion-skeleton-text [animated]="true" style="height: 17px; width: 90px; border-radius: 10px"></ion-skeleton-text>
              <ion-skeleton-text [animated]="true" style="height: 17px; width: 85px; border-radius: 10px"></ion-skeleton-text>
              <ion-skeleton-text [animated]="true" style="height: 17px; width: 80px; border-radius: 10px"></ion-skeleton-text>
              <ion-skeleton-text [animated]="true" style="height: 17px; width: 70px; border-radius: 10px"></ion-skeleton-text>
            </ion-list>
            <ion-list lines="none" class="list" style="display: flex; flex-direction: column; align-items: end">
              <div class="coverstock">
                <ion-skeleton-text [animated]="true" style="height: 20px; width: 15vh; border-radius: 10px"></ion-skeleton-text>
              </div>
              <ion-skeleton-text [animated]="true" style="height: 17px; width: 100px; border-radius: 10px"></ion-skeleton-text>
              <ion-skeleton-text [animated]="true" style="height: 17px; width: 85px; border-radius: 10px"></ion-skeleton-text>
              <ion-skeleton-text [animated]="true" style="height: 17px; width: 80px; border-radius: 10px"></ion-skeleton-text>
            </ion-list>
          </div>
        </ion-card-content>
        <ion-button style="float: right" fill="clear">
          <ion-skeleton-text [animated]="true" style="width: 150px; height: 20px; border-radius: 10px"></ion-skeleton-text>
        </ion-button>
      </ion-card>
    }
  }
</ion-content>

<ion-modal [initialBreakpoint]="0.35" [breakpoints]="[0, 0.35, 0.5, 0.75]" #coverstock>
  <ng-template>
    <app-ball-list [balls]="coverstockBalls" [isCoverstock]="true" (ballSelected)="onBallSelected($event)"></app-ball-list>
  </ng-template>
</ion-modal>

<ion-modal [initialBreakpoint]="0.35" [breakpoints]="[0, 0.35, 0.5, 0.75]" #core>
  <ng-template>
    <app-ball-list [balls]="coreBalls" [isCoverstock]="false" (ballSelected)="onBallSelected($event)"></app-ball-list>
  </ng-template>
</ion-modal>

<ion-modal [initialBreakpoint]="0.35" [breakpoints]="[0, 0.35, 0.5, 0.75]" #movement>
  <ng-template>
    <!--This is done so i dont have to programmtically create the modal and still have the title of the ball without it being inside the modal-->
    <app-ball-list
      [balls]="movementBalls.slice(1, 10)"
      [isCoverstock]="false"
      [title]="'Similar reaction to ' + movementBalls[0]!.ball_name"
      (ballSelected)="onBallSelected($event)"></app-ball-list>
  </ng-template>
</ion-modal>
