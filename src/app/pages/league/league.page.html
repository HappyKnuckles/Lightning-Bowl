<ion-header [translucent]="true">
  <ion-toolbar>
    @if (!isVisibilityEdit()) {
      <ion-buttons slot="end">
        <ion-button type="button" class="action-sheet" fill="clear" (click)="openLeagueSelector()">
          <ion-icon slot="icon-only" name="add-outline"></ion-icon>
        </ion-button>
      </ion-buttons>
    } @else {
      <ion-buttons slot="end">
        <ion-button type="button" class="action-sheet" fill="clear" strong="true" (click)="editVisibility()"> Save </ion-button>
      </ion-buttons>
      <ion-buttons slot="start">
        <ion-button type="button" class="action-sheet" fill="clear" (click)="cancelEdit()"> Cancel </ion-button>
      </ion-buttons>
    }
    <ion-title> Leagues/Tournaments </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- Hidden League Selector Component for League Management -->
  <app-league-selector [isAddPage]="false" style="display: none" #leagueSelector></app-league-selector>
  <!-- Show this message if there are no game history items and it's not loading -->
  <ng-container *ngIf="storageService.games().length <= 0 && !loadingService.isLoading(); else noLeagues">
    <ion-text class="no-game-text"> Start playing a few games to see your leagues here! </ion-text>
  </ng-container>

  <ng-template #noLeagues>
    <ng-container *ngIf="leagues().length <= 0 && !loadingService.isLoading(); else content">
      <ion-text class="no-game-text"> No leagues saved! </ion-text>
    </ng-container>
  </ng-template>

  <ng-template #content>
    @if (noLeaguesShown && !isVisibilityEdit()) {
      <ion-text class="no-game-text" (longPressed)="editVisibility()" [delay]="1000" appLongPress> No leagues selected to show! </ion-text>
    } @else {
      @for (league of leagues(); track league.name) {
        @if (isVisibilityEdit()) {
          @if (leagueSelectionState; as selectionState) {
            <div class="sliding">
              <ion-item button #leagues (longPressed)="editVisibility()" [delay]="1000" appLongPress detail="false">
                <ion-checkbox [checked]="selectionState[league.name]" (ionChange)="updateLeagueSelection(league, $event.detail.checked)">
                  <ion-label class="game-info">
                    <h2 class="title">{{ league.name }}</h2>
                    <p class="score">Games: {{ gamesByLeague()[league.name].length || 0 }}</p>
                    <p class="score">Avg: {{ statsByLeague()[league.name].averageScore | number: "1.1-2" }}</p>
                    <p class="score">High: {{ statsByLeague()[league.name].highGame }}</p>
                  </ion-label>
                </ion-checkbox>
              </ion-item>
            </div>
          }
        } @else {
          @if (league.show) {
            @if (league.name === "Practice") {
              <div class="sliding">
                <ion-item
                  (click)="loadingService.setLoading(true)"
                  button
                  [id]="league.name"
                  (longPressed)="editVisibility()"
                  [delay]="1000"
                  appLongPress>
                  <ion-label class="game-info">
                    <div class="title">{{ league.name }}</div>
                    <div class="score">Games: {{ gamesByLeague()[league.name].length || 0 }}</div>
                    <div class="score">Avg: {{ statsByLeague()[league.name].averageScore | number: "1.1-2" }}</div>
                    <div class="score">High: {{ statsByLeague()[league.name].highGame }}</div>
                  </ion-label>
                </ion-item>
              </div>
            } @else {
              <ion-item-sliding class="sliding" #slidingItem>
                <ion-item-options side="end" (ionSwipe)="deleteLeague(league); slidingItem.closeOpened()">
                  <ion-item-option color="danger" expandable (click)="deleteLeague(league); slidingItem.closeOpened()">
                    <ion-icon class="title" style="transform: translateY(-2px)" name="trash-outline"></ion-icon>
                  </ion-item-option>
                </ion-item-options>

                <ion-item-options side="start" (ionSwipe)="editLeague(league); slidingItem.closeOpened()">
                  <ion-item-option expandable (click)="editLeague(league); slidingItem.closeOpened()">
                    <ion-icon class="title" style="transform: translateY(-2px)" name="create-outline"></ion-icon>
                  </ion-item-option>
                </ion-item-options>

                <ion-item
                  (click)="loadingService.setLoading(true)"
                  button
                  [id]="league.name"
                  (longPressed)="editVisibility()"
                  [delay]="1000"
                  appLongPress>
                  <ion-label class="game-info">
                    <div class="title">{{ league.name }}</div>
                    <div class="score">Games: {{ gamesByLeague()[league.name].length || 0 }}</div>
                    <div class="score">Avg: {{ statsByLeague()[league.name].averageScore | number: "1.1-2" }}</div>
                    <div class="score">High: {{ statsByLeague()[league.name].highGame }}</div>
                  </ion-label>
                </ion-item>
              </ion-item-sliding>
            }
          }
        }
      }
    }
  </ng-template>
</ion-content>

@for (league of leagues(); track $index) {
  @if (league.show && !isVisibilityEdit()) {
    <ion-modal
      [trigger]="league"
      #modal
      (didDismiss)="destroyCharts(league.name)"
      (didPresent)="loadingService.setLoading(false); generateCharts(league.name, true)">
      <ng-template>
        <ion-header [translucent]="true">
          <ion-toolbar>
            <ion-buttons slot="start" style="padding: 4px">
              <ion-button (click)="closeModal(league.name)">
                <ion-icon name="chevron-back" slot="icon-only"></ion-icon>
              </ion-button>
            </ion-buttons>
            <ion-title>{{ league }}</ion-title>
          </ion-toolbar>

          <ion-toolbar>
            <ion-segment [value]="selectedSegment" (ionChange)="onSegmentChanged(league.name, $event)">
              @for (segment of segments; track segment) {
                <ion-segment-button [value]="segment" [contentId]="segment + '-' + league">
                  <ion-label class="segment-label">{{ segment }}</ion-label>
                </ion-segment-button>
              }
            </ion-segment>
          </ion-toolbar>
        </ion-header>

        <ion-content #modalContent>
          <ion-segment-view>
            <ion-segment-content id="Overall-{{ league }}">
              <section class="tab">
                <app-stat-display
                  [statDefinitions]="statDefinitions"
                  [title]="'Overall Stats'"
                  [currentStats]="statsByLeague()[league.name]"
                  [prevStats]="overallStats()">
                </app-stat-display>
                <app-ball-stats
                  [title]="'Most used ball'"
                  [bestBall]="mostPlayedBallsByLeague()[league.name]"
                  [totalGames]="statsByLeague()[league.name].totalGames"></app-ball-stats>
                <app-ball-stats
                  [title]="'Best ball'"
                  [bestBall]="bestBallsByLeague()[league.name]"
                  [totalGames]="statsByLeague()[league.name].totalGames"></app-ball-stats>
                <div class="stat-container">
                  <canvas #scoreChart style="width: 300px; height: 400px; max-height: 700px"></canvas>
                </div>
              </section>
            </ion-segment-content>

            <ion-segment-content id="Spares-{{ league }}">
              <section class="tab">
                <ion-list-header>Spares Overview</ion-list-header>
                <app-spare-display [prevStats]="overallStats()" [stats]="statsByLeague()[league.name]" id="league-spareStats"> </app-spare-display>
                <div class="stat-container">
                  <canvas #pinChart style="width: 300px; height: 300px; max-height: 700px"></canvas>
                </div>
              </section>
            </ion-segment-content>

            <ion-segment-content id="Games-{{ league }}">
              <app-game [games]="gamesByLeague()[league.name]" [gameCount]="gamesByLeague()[league.name].length" [isLeaguePage]="true"> </app-game>
            </ion-segment-content>
          </ion-segment-view>
        </ion-content>
      </ng-template>
    </ion-modal>
  }
}
