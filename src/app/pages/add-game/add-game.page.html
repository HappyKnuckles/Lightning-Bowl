<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button type="button" class="action-sheet" slot="start" fill="clear" (click)="handleImageUpload()">
        <ion-icon slot="icon-only" name="camera-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <input type="file" id="upload" class="ion-hide" accept="image/*" />
    <ion-title> Add Game </ion-title>
    <ion-buttons slot="end">
      <ion-button class="action-sheet" (click)="presentActionSheet()" fill="clear">
        {{ selectedMode }}
        <ion-icon *ngIf="!sheetOpen" name="chevron-down" class="chevron"></ion-icon>
        <ion-icon *ngIf="sheetOpen" name="chevron-up" class="chevron"></ion-icon>
      </ion-button>
      <ion-button fill="clear" (click)="toggleInputMode()">
        <ion-icon [name]="usePinInput ? 'calculator-outline' : 'grid-outline'" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  @if (selectedMode !== "Single") {
    <ion-toolbar>
      <ion-segment [value]="selectedSegment" [scrollable]="true">
        <ion-segment-button *ngFor="let segment of segments" [value]="segment" [contentId]="segment">
          <ion-label class="segment-label">{{ segment }}</ion-label>
        </ion-segment-button>
      </ion-segment>
    </ion-toolbar>
  }
</ion-header>

<ion-alert [isOpen]="isAlertOpen" header="Error" message="You didn't fill all inputs" [buttons]="['Dismiss']" (didDismiss)="isAlertOpen = false">
</ion-alert>

<div
  *ngIf="is300"
  style="
    position: absolute;
    background-color: rgba(0, 0, 0, 0.5);
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 500;
  ">
  <lottie-player slot="end" autoplay loop src="https://lottie.host/7b3bdd2a-221b-463e-9f59-d95964639389/duMcnXopMJ.json"></lottie-player>
</div>

<ng-container *ngFor="let mode of seriesMode; let i = index">
  <ion-content [fullscreen]="true" *ngIf="mode">
    <ion-segment-view>
      <ion-segment-content *ngFor="let trackIndex of trackIndexes[i]; let j = index" [id]="segments[j]">
        <app-game-grid
          *ngIf="!usePinInput"
          (maxScoreChanged)="onMaxScoreChanged($event, trackIndex)"
          (totalScoreChanged)="onTotalScoreChange($event, trackIndex)"
          (leagueChanged)="onLeagueChange($event)"
          (patternChanged)="onPatternChange($event)"
          (isPracticeChanged)="onIsPracticeChange($event)"
          [patternId]="j.toString()"></app-game-grid>
        <div *ngIf="usePinInput" class="pin-input-container">
          <!-- Display current game state with pin input -->
          <div class="pin-game-display">
            <!-- Frame display grid -->
            <div class="pin-frames-grid">
              <ion-grid fixed="true" *ngFor="let frameNum of [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]; let frameIndex = index">
                <ion-row>
                  <ion-col class="middle frame">{{ frameNum }}</ion-col>
                </ion-row>
                <ion-row>
                  <!-- Frames 1-9: Show 2 throws -->
                  <ion-col class="input-col" *ngIf="frameNum !== 10"></ion-col>
                  <ion-col class="input-col" *ngIf="frameNum !== 10">
                    <div class="pin-throw-display">{{ getPinInputFrameValue(trackIndex, frameIndex, 0) }}</div>
                  </ion-col>
                  <ion-col class="input-col" *ngIf="frameNum !== 10">
                    <div class="pin-throw-display">{{ getPinInputFrameValue(trackIndex, frameIndex, 1) }}</div>
                  </ion-col>
                  
                  <!-- Frame 10: Show 3 throws -->
                  <ion-col class="input-col" *ngIf="frameNum === 10">
                    <div class="pin-throw-display">{{ getPinInputFrameValue(trackIndex, frameIndex, 0) }}</div>
                  </ion-col>
                  <ion-col class="input-col" *ngIf="frameNum === 10">
                    <div class="pin-throw-display">{{ getPinInputFrameValue(trackIndex, frameIndex, 1) }}</div>
                  </ion-col>
                  <ion-col class="input-col" *ngIf="frameNum === 10">
                    <div class="pin-throw-display">{{ getPinInputFrameValue(trackIndex, frameIndex, 2) }}</div>
                  </ion-col>
                </ion-row>
                <ion-row>
                  <ion-col class="middle count">{{ getPinInputFrameScore(trackIndex, frameIndex) }}</ion-col>
                </ion-row>
              </ion-grid>
            </div>
            
            <!-- Control section -->
            <ion-card>
              <ion-card-header>
                <ion-card-title>Pin Setup Input - Game {{ j + 1 }}</ion-card-title>
                <ion-card-subtitle>Current Progress: Frame {{ getCurrentPinFrame(trackIndex) }}, {{ getCurrentPinThrow(trackIndex) }}</ion-card-subtitle>
              </ion-card-header>
              <ion-card-content>
                <div class="pin-input-progress">
                  <p><strong>Total Score:</strong> {{ totalScores[trackIndex] || 0 }}</p>
                  <p><strong>Max Possible:</strong> {{ maxScores[trackIndex] || 300 }}</p>
                </div>
                <div class="pin-input-buttons">
                  <ion-button (click)="startPinInput(trackIndex)" expand="block" fill="outline" *ngIf="!isPinInputActive(trackIndex)">
                    Start Pin Input
                  </ion-button>
                  <ion-button (click)="continuePinInput(trackIndex)" expand="block" color="primary" *ngIf="isPinInputActive(trackIndex)">
                    Continue Frame {{ getCurrentPinFrame(trackIndex) }}
                  </ion-button>
                </div>
              </ion-card-content>
            </ion-card>
          </div>
        </div>
        <ion-grid *ngIf="i !== 0">
          <ion-row>
            <ion-col class="middle count">Total: {{ totalScores[trackIndex] }}</ion-col>
            <ion-col class="middle count">Max: {{ maxScores[trackIndex] }}</ion-col>
          </ion-row>
          <ion-row class="button-row">
            <ion-col>
              <ion-button (click)="clearFrames(j)">Clear Score</ion-button>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-segment-content>
    </ion-segment-view>

    <ion-grid *ngIf="i === 0">
      <ion-row>
        <ion-col class="middle count">Total: {{ totalScores[i] }}</ion-col>
        <ion-col class="middle count">Max: {{ maxScores[i] }}</ion-col>
      </ion-row>
      <ion-row class="button-row">
        <ion-col>
          <ion-button (click)="clearFrames()">Clear Score</ion-button>
        </ion-col>
        <ion-col>
          <ion-button (click)="calculateScore()">Save Score</ion-button>
        </ion-col>
      </ion-row>
    </ion-grid>

    <ion-grid *ngIf="i !== 0">
      <ion-row>
        <ion-col class="middle count">Score Series: {{ getSeriesCurrentScore(i) }}</ion-col>
        <ion-col class="middle count">Max Series: {{ getSeriesMaxScore(i) }}</ion-col>
      </ion-row>
      <ion-row class="button-row">
        <ion-col>
          <ion-button (click)="clearFrames()">Clear Scores</ion-button>
        </ion-col>
        <ion-col>
          <ion-button (click)="calculateScore()">Save Series</ion-button>
        </ion-col>
      </ion-row>
    </ion-grid>
  </ion-content>
</ng-container>

<ion-modal [isOpen]="isModalOpen" (didDismiss)="isModalOpen = false">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="cancel()">Cancel</ion-button>
        </ion-buttons>
        <ion-title>Your game</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="confirm()" [strong]="true" [disabled]="!isGameValid(modalGrid.game())">Save</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content>
      <h2 class="ion-text-center">Edit wrong game data</h2>
      <app-game-grid
        #modalGrid
        (leagueChanged)="onLeagueChange($event)"
        (isPracticeChanged)="onIsPracticeChange($event)"
        [game]="gameData"
        [patternId]="gameData.gameId"></app-game-grid>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isPinSetupModalOpen" (didDismiss)="closePinSetupModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closePinSetupModal()" fill="clear">Cancel</ion-button>
        </ion-buttons>
        <ion-title>Pin Setup - Frame {{ currentFrame }} {{ currentThrowLabel }}</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="skipPinSetup()" fill="clear" color="medium">Skip</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content>
      <!-- Game progress display -->
      <div class="game-progress" *ngIf="currentGameIndex >= 0">
        <ion-card>
          <ion-card-header>
            <ion-card-subtitle>Current Game Progress</ion-card-subtitle>
          </ion-card-header>
          <ion-card-content>
            <div class="progress-info">
              <p><strong>Frame:</strong> {{ currentFrame }} of 10</p>
              <p><strong>Throw:</strong> {{ currentThrowLabel }}</p>
              <p><strong>Current Total:</strong> {{ totalScores[currentGameIndex] || 0 }}</p>
              <p><strong>Remaining Pins:</strong> {{ availablePins.length }}</p>
            </div>
          </ion-card-content>
        </ion-card>
      </div>
      
      <app-pin-setup
        [frameNumber]="currentFrame"
        [throwIndex]="currentThrowIndex"
        [previousPins]="availablePins"
        (throwConfirmed)="onPinThrowConfirmed($event)"
        (cancelled)="closePinSetupModal()">
      </app-pin-setup>
    </ion-content>
  </ng-template>
</ion-modal>
