<ion-header [translucent]="true" class="ion-text-center">
  <ion-toolbar>
    <ion-title> Stats </ion-title>
  </ion-toolbar>
  <ion-segment [(ngModel)]="selectedSegment" value="Overall" (ionChange)="onSegmentChanged($event)">
    <ion-segment-button *ngFor="let segment of segments" [value]="segment">
      <ion-label class="segmentLabel">{{segment}}</ion-label>
    </ion-segment-button>
  </ion-segment>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)"></ion-refresher>
  <!-- Show this message if there are no game history items and it's not loading -->
  <ng-container *ngIf="gameHistory.length <= 0 && !isLoading; else content">
    <ion-text
      style="width: 60%; display: flex; justify-content: center; height: 100%; align-items: center; margin: 0 auto">
      Start playing a few games to see your stats here!
    </ion-text>
  </ng-container>

  <!-- Main content to display when there is game history or when loading is done -->
  <ng-template #content>
    <swiper-container [modules]="swiperModules" #swiper [slidesPerView]="1" (swiperslidechange)="onSlideChanged()"
      loop="true">
      <!-- Overall Segment -->
      <swiper-slide class="tab">
        <div class="stats">
          <ion-text>Games: </ion-text>
          <ion-text class="value">{{ stats.totalGames }}</ion-text>
        </div>

        <div class="stats">
          <ion-text>Clean games: </ion-text>
          <ion-text class="value" id="cleanGameCount">
            {{ stats.cleanGameCount }}
            <ion-icon *ngIf="getArrowIcon(stats.cleanGameCount, prevStats.cleanGameCount)"
              [name]="getArrowIcon(stats.cleanGameCount, prevStats.cleanGameCount)"
              [color]="getDiffColor(stats.cleanGameCount, prevStats.cleanGameCount)">
            </ion-icon>
          </ion-text>
          <ion-popover class="diffPopover" trigger="cleanGameCount"
            *ngIf="getStatDifference(stats.cleanGameCount, prevStats.cleanGameCount) !== '0'">
            <ion-text [color]="getDiffColor(stats.cleanGameCount, prevStats.cleanGameCount)">
              {{getStatDifference(stats.cleanGameCount, prevStats.cleanGameCount)}}
            </ion-text>
          </ion-popover>
        </div>

        <div class="stats">
          <ion-text>Perfect games: </ion-text>
          <ion-text class="value" id="perfectGameCount">
            {{ stats.perfectGameCount }}
            <ion-icon *ngIf="getArrowIcon(stats.perfectGameCount, prevStats.perfectGameCount)"
              [name]="getArrowIcon(stats.perfectGameCount, prevStats.perfectGameCount)"
              [color]="getDiffColor(stats.perfectGameCount, prevStats.perfectGameCount)">
            </ion-icon>
          </ion-text>
          <ion-popover class="diffPopover" trigger="perfectGameCount"
            *ngIf="getStatDifference(stats.perfectGameCount, prevStats.perfectGameCount) !== '0'">
            <ion-text [color]="getDiffColor(stats.perfectGameCount, prevStats.perfectGameCount)">
              {{getStatDifference(stats.perfectGameCount, prevStats.perfectGameCount)}}
            </ion-text>
          </ion-popover>
        </div>

        <div class="stats">
          <ion-text>Average: </ion-text>
          <ion-text class="value" id="averageScore">
            {{ stats.averageScore | number:'1.2-2' }}
            <ion-icon *ngIf="getArrowIcon(stats.averageScore, prevStats.averageScore)"
              [name]="getArrowIcon(stats.averageScore, prevStats.averageScore)"
              [color]="getDiffColor(stats.averageScore, prevStats.averageScore)">
            </ion-icon>
          </ion-text>
          <ion-popover class="diffPopover" trigger="averageScore"
            *ngIf="getStatDifference(stats.averageScore, prevStats.averageScore) !== '0'">
            <ion-text [color]="getDiffColor(stats.averageScore, prevStats.averageScore)">
              {{getStatDifference(stats.averageScore, prevStats.averageScore)}}
            </ion-text>
          </ion-popover>
        </div>

        <div class="stats">
          <ion-text>High game: </ion-text>
          <ion-text class="value">{{ stats.highGame }}</ion-text>
        </div>

        <div class="stats">
          <ion-text>Total pins: </ion-text>
          <ion-text class="value">{{ stats.totalPins }}</ion-text>
        </div>

        <div class="stats">
          <ion-text>First ball average: </ion-text>
          <ion-text class="value" id="averageFirstCount">
            {{ stats.averageFirstCount | number:'1.2-2' }}
            <ion-icon *ngIf="getArrowIcon(stats.averageFirstCount, prevStats.averageFirstCount)"
              [name]="getArrowIcon(stats.averageFirstCount, prevStats.averageFirstCount)"
              [color]="getDiffColor(stats.averageFirstCount, prevStats.averageFirstCount)">
            </ion-icon>
          </ion-text>
          <ion-popover class="diffPopover" trigger="averageFirstCount"
            *ngIf="getStatDifference(stats.averageFirstCount, prevStats.averageFirstCount) !== '0'">
            <ion-text [color]="getDiffColor(stats.averageFirstCount, prevStats.averageFirstCount)">
              {{getStatDifference(stats.averageFirstCount, prevStats.averageFirstCount)}}
            </ion-text>
          </ion-popover>
        </div>

        <div class="stats">
          <ion-text>Total strikes: </ion-text>
          <ion-text class="value">{{ stats.totalStrikes }}</ion-text>
        </div>

        <div class="stats">
          <ion-text>Strikes per game: </ion-text>
          <ion-text class="value" id="averageStrikesPerGame">
            {{ stats.averageStrikesPerGame | number:'1.2-2' }}
            <ion-icon *ngIf="getArrowIcon(stats.averageStrikesPerGame, prevStats.averageStrikesPerGame)"
              [name]="getArrowIcon(stats.averageStrikesPerGame, prevStats.averageStrikesPerGame)"
              [color]="getDiffColor(stats.averageStrikesPerGame, prevStats.averageStrikesPerGame)">
            </ion-icon>
          </ion-text>
          <ion-popover class="diffPopover" trigger="averageStrikesPerGame"
            *ngIf="getStatDifference(stats.averageStrikesPerGame, prevStats.averageStrikesPerGame) !== '0'">
            <ion-text [color]="getDiffColor(stats.averageStrikesPerGame, prevStats.averageStrikesPerGame)">
              {{getStatDifference(stats.averageStrikesPerGame, prevStats.averageStrikesPerGame)}}
            </ion-text>
          </ion-popover>
        </div>

        <div class="stats">
          <ion-text>Strike-percentage: </ion-text>
          <ion-text class="value" id="strikePercentage">
            {{ stats.strikePercentage | number:'1.2-2' }}%
            <ion-icon *ngIf="getArrowIcon(stats.strikePercentage, prevStats.strikePercentage)"
              [name]="getArrowIcon(stats.strikePercentage, prevStats.strikePercentage)"
              [color]="getDiffColor(stats.strikePercentage, prevStats.strikePercentage)">
            </ion-icon>
          </ion-text>
          <ion-popover class="diffPopover" trigger="strikePercentage"
            *ngIf="getStatDifference(stats.strikePercentage, prevStats.strikePercentage) !== '0'">
            <ion-text [color]="getDiffColor(stats.strikePercentage, prevStats.strikePercentage)">
              {{getStatDifference(stats.strikePercentage, prevStats.strikePercentage)}}
            </ion-text>
          </ion-popover>
        </div>

        <div class="stats">
          <ion-text>Total spares: </ion-text>
          <ion-text class="value">{{ stats.totalSpares }}</ion-text>
        </div>

        <div class="stats">
          <ion-text>Spares per game: </ion-text>
          <ion-text class="value" id="averageSparesPerGame">
            {{ stats.averageSparesPerGame | number:'1.2-2' }}
            <ion-icon *ngIf="getArrowIcon(stats.averageSparesPerGame, prevStats.averageSparesPerGame)"
              [name]="getArrowIcon(stats.averageSparesPerGame, prevStats.averageSparesPerGame)"
              [color]="getDiffColor(stats.averageSparesPerGame, prevStats.averageSparesPerGame)">
            </ion-icon>
          </ion-text>
          <ion-popover class="diffPopover" trigger="averageSparesPerGame"
            *ngIf="getStatDifference(stats.averageSparesPerGame, prevStats.averageSparesPerGame) !== '0'">
            <ion-text [color]="getDiffColor(stats.averageSparesPerGame, prevStats.averageSparesPerGame)">
              {{getStatDifference(stats.averageSparesPerGame, prevStats.averageSparesPerGame)}}
            </ion-text>
          </ion-popover>
        </div>

        <div class="stats">
          <ion-text>Spare-percentage: </ion-text>
          <ion-text class="value" id="sparePercentage">
            {{ stats.overallSpareRate | number:'1.2-2' }}%
            <ion-icon *ngIf="getArrowIcon(stats.overallSpareRate, prevStats.overallSpareRate)"
              [name]="getArrowIcon(stats.overallSpareRate, prevStats.overallSpareRate)"
              [color]="getDiffColor(stats.overallSpareRate, prevStats.overallSpareRate)">
            </ion-icon>
          </ion-text>
          <ion-popover class="diffPopover" trigger="sparePercentage"
            *ngIf="getStatDifference(stats.overallSpareRate, prevStats.overallSpareRate) !== '0'">
            <ion-text [color]="getDiffColor(stats.overallSpareRate, prevStats.overallSpareRate)">
              {{getStatDifference(stats.overallSpareRate, prevStats.overallSpareRate)}}
            </ion-text>
          </ion-popover>
        </div>

        <div class="stats">
          <ion-text>Total opens: </ion-text>
          <ion-text class="value">{{ stats.totalSparesMissed }}</ion-text>
        </div>
        <div class="stats">
          <ion-text>Opens per game: </ion-text>
          <ion-text class="value" id="averageOpensPerGame">
            {{ stats.averageOpensPerGame | number:'1.2-2' }}
            <ion-icon *ngIf="getArrowIcon(stats.averageOpensPerGame, prevStats.averageOpensPerGame)"
              [name]="getArrowIcon(stats.averageOpensPerGame, prevStats.averageOpensPerGame)"
              [color]="getDiffColor(stats.averageOpensPerGame, prevStats.averageOpensPerGame)">
            </ion-icon>
          </ion-text>
          <ion-popover class="diffPopover" trigger="averageOpensPerGame"
            *ngIf="getStatDifference(stats.averageOpensPerGame, prevStats.averageOpensPerGame) !== '0'">
            <ion-text [color]="getDiffColor(stats.averageOpensPerGame, prevStats.averageOpensPerGame)">
              {{getStatDifference(stats.averageOpensPerGame, prevStats.averageOpensPerGame)}}
            </ion-text>
          </ion-popover>
        </div>

        <div class="stats">
          <ion-text>Open-percentage: </ion-text>
          <ion-text class="value" id="openPercentage">
            {{ stats.overallMissedRate | number:'1.2-2' }}%
            <ion-icon *ngIf="getArrowIcon(stats.overallMissedRate, prevStats.overallMissedRate)"
              [name]="getArrowIcon(stats.overallMissedRate, prevStats.overallMissedRate)"
              [color]="getDiffColor(stats.overallMissedRate, prevStats.overallMissedRate)">
            </ion-icon>
          </ion-text>
          <ion-popover class="diffPopover" trigger="openPercentage"
            *ngIf="getStatDifference(stats.overallMissedRate, prevStats.overallMissedRate) !== '0'">
            <ion-text [color]="getDiffColor(stats.overallMissedRate, prevStats.overallMissedRate)">
              {{getStatDifference(stats.overallMissedRate, prevStats.overallMissedRate)}}
            </ion-text>
          </ion-popover>
        </div>

        <canvas #scoreChart class="score" style="width: 300px; height: 300px"></canvas>
      </swiper-slide>

      <!-- Spares Segment -->
      <swiper-slide class="tab">
        <ion-grid class="statGrid">
          <ion-row style="font-weight: bold">
            <ion-col><ion-text>Count</ion-text></ion-col>
            <ion-col><ion-text>Missed</ion-text></ion-col>
            <ion-col><ion-text>Converted</ion-text></ion-col>
            <ion-col><ion-text>Rate</ion-text></ion-col>
          </ion-row>
          <ion-row *ngFor="let i of [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10]">
            <ion-col><ion-text>{{ getLabel(i) }}</ion-text></ion-col>
            <!-- Display each pin count -->
            <ng-container *ngIf="i > 0">
              <ion-col><ion-text>{{ stats.missedCounts[i] }}</ion-text></ion-col>
              <ion-col><ion-text>{{ stats.pinCounts[i] }}</ion-text></ion-col>
              <ion-col *ngIf="stats.pinCounts[i] === 0 && stats.missedCounts[i] === 0"></ion-col>
              <ion-col id="spareRates{{i}}" *ngIf="stats.pinCounts[i] !== 0 || stats.missedCounts[i] !== 0"
                [ngStyle]="{'color': getRateColor(stats.spareRates[i])}">
                <ion-text>{{ stats.spareRates[i] | number:'1.2-2' }}%
                  <ion-icon *ngIf="getArrowIcon(stats.spareRates[i], prevStats.spareRates[i])"
                    [name]="getArrowIcon(stats.spareRates[i], prevStats.spareRates[i])"
                    [color]="getDiffColor(stats.spareRates[i], prevStats.spareRates[i])">
                  </ion-icon>
                </ion-text>

                <ion-popover class="diffPopover" trigger="spareRates{{i}}"
                  *ngIf="getStatDifference(stats.spareRates[i], prevStats.spareRates[i]) !== '0'">
                  <ion-text [color]="getDiffColor(stats.spareRates[i], prevStats.spareRates[i])">
                    {{getStatDifference(stats.spareRates[i], prevStats.spareRates[i])}}
                  </ion-text>
                </ion-popover>
              </ion-col>
            </ng-container>
            <!-- Display total spares and conversion rate -->
            <ng-container *ngIf="i === 0">
              <ion-col><ion-text>{{ stats.totalSparesMissed }}</ion-text></ion-col>
              <ion-col><ion-text>{{ stats.totalSparesConverted }}</ion-text></ion-col>
              <ion-col id="overallSpareRate" *ngIf="stats.totalSparesMissed + stats.totalSparesConverted !== 0"
                [ngStyle]="{'color': getRateColor(stats.overallSpareRate)}">
                <ion-text>{{ stats.overallSpareRate | number:'1.2-2' }}%
                  <ion-icon *ngIf="getArrowIcon(stats.overallSpareRate, prevStats.overallSpareRate)"
                    [name]="getArrowIcon(stats.overallSpareRate, prevStats.overallSpareRate)"
                    [color]="getDiffColor(stats.overallSpareRate, prevStats.overallSpareRate)">
                  </ion-icon>
                </ion-text>

                <ion-popover class="diffPopover" trigger="overallSpareRate"
                  *ngIf="getStatDifference(stats.overallSpareRate, prevStats.overallSpareRate) !== '0'">
                  <ion-text [color]="getDiffColor(stats.overallSpareRate, prevStats.overallSpareRate)">
                    {{getStatDifference(stats.overallSpareRate, prevStats.overallSpareRate)}}
                  </ion-text>
                </ion-popover>
              </ion-col>
              <ion-col *ngIf="stats.totalSparesMissed + stats.totalSparesConverted === 0"></ion-col>
            </ng-container>
          </ion-row>
        </ion-grid>

        <canvas #pinChart class="spares" style="width: 300px; height: 300px"></canvas>
      </swiper-slide>

      <!-- Throws Segment -->
      <swiper-slide class="tab">
        <canvas #throwChart class="throws" style="width: 300px; height: 300px"></canvas>
      </swiper-slide>

      <swiper-slide class="tab">
        <div class="stats">
          <ion-text>Games: </ion-text>
          <ion-text class="value"></ion-text>
        </div>
      </swiper-slide>
    </swiper-container>
  </ng-template>
</ion-content>