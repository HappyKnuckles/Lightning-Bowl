<div class="grid-container">
  <ion-grid fixed="true" *ngFor="let i of [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]; let frameIndex = index">
    <ion-row>
      <ion-col class="middle frame">{{ i }}</ion-col>
    </ion-row>
    <ion-row>
      <ion-col class="input-col" *ngIf="i !== 10"></ion-col>
      <ion-col class="input-col">
        <ion-input
          type="text"
          clearOnEdit="true"
          inputmode="numeric"
          autocapitalize="on"
          [value]="getFrameValue(frameIndex, 0)"
          (ionInput)="simulateScore($event, frameIndex, 0)"
          (ionFocus)="handleInputFocus(frameIndex, 0)"
          (ionBlur)="handleInputBlur()">
        </ion-input>
      </ion-col>
      <ion-col class="input-col" *ngIf="i !== 10">
        <ion-input
          type="text"
          clearOnEdit="true"
          inputmode="numeric"
          autocapitalize="on"
          [disabled]="game().frames[frameIndex][0] === 10 && i !== 10"
          [value]="getFrameValue(frameIndex, 1)"
          (ionInput)="simulateScore($event, frameIndex, 1)"
          (ionFocus)="handleInputFocus(frameIndex, 1)"
          (ionBlur)="handleInputBlur()">
        </ion-input>
      </ion-col>
      <ion-col class="input-col" *ngIf="i === 10">
        <ion-input
          type="text"
          clearOnEdit="true"
          inputmode="numeric"
          autocapitalize="on"
          [disabled]="game().frames[frameIndex][0] === 10 && i !== 10"
          [value]="getFrameValue(frameIndex, 1)"
          (ionInput)="simulateScore($event, frameIndex, 1)"
          (ionFocus)="handleInputFocus(frameIndex, 1)"
          (ionBlur)="handleInputBlur()">
        </ion-input>
      </ion-col>
      <ion-col class="input-col" *ngIf="i === 10">
        <ion-input
          type="text"
          clearOnEdit="true"
          inputmode="numeric"
          autocapitalize="on"
          [value]="getFrameValue(frameIndex, 2)"
          [disabled]="game().frames[frameIndex][0] !== 10 && game().frames[frameIndex][0] + (game().frames[frameIndex][1] || 0) !== 10"
          (ionInput)="simulateScore($event, frameIndex, 2)"
          (ionFocus)="handleInputFocus(frameIndex, 2)"
          (ionBlur)="handleInputBlur()">
        </ion-input>
      </ion-col>
    </ion-row>
    <ion-row>
      <ion-col class="middle count">
        <ng-container
          *ngIf="
            (game().frames[frameIndex][0] !== undefined ||
              game().frames[frameIndex][1] !== undefined ||
              (i === 10 && game().frames[frameIndex][0] !== undefined && game().frames[frameIndex][1] !== undefined)) &&
            isNumber(game().frameScores[i - 1])
          ">
          {{ game().frameScores[i - 1] }}
        </ng-container>

        <ng-container *ngIf="i === 10 && (game().frames[frameIndex][0] === undefined || game().frames[frameIndex][1] === undefined)">
          <span style="color: var(--ion-color-secondary)"> ({{ maxScore }}) </span>
        </ng-container>
      </ion-col>

      <ion-col
        *ngIf="
          !(
            (game().frames[frameIndex][0] !== undefined ||
              game().frames[frameIndex][1] !== undefined ||
              (i === 10 && game().frames[frameIndex][0] !== undefined)) &&
            isNumber(game().frameScores[i - 1])
          ) && !(i === 10 && game().frames[frameIndex][0] === undefined)
        "
        class="middle count"
        style="color: var(--ion-color-quartiary)"
        >0</ion-col
      >
    </ion-row>
  </ion-grid>

  <div class="score-toolbar" *ngIf="showMetadata()" [class.show]="showButtonToolbar" [ngStyle]="{ bottom: keyboardOffset + 'px' }">
    <ion-button (click)="selectSpecialScore('X')" (mousedown)="$event.preventDefault()" [disabled]="isStrikeButtonDisabled()"> X </ion-button>
    <ion-button (click)="selectSpecialScore('/')" (mousedown)="$event.preventDefault()" [disabled]="isSpareButtonDisabled()"> / </ion-button>
  </div>
</div>

@if (showMetadata()) {
  <div style="margin: 0 5px">
    <ion-list lines="full" style="border-radius: 7px">
      <ion-item>
        <ion-checkbox [(ngModel)]="game().isPractice" name="isPractice" #checkbox (ionChange)="isPracticeChanged.emit(game().isPractice)"
          >Practice</ion-checkbox
        >
      </ion-item>
      <!-- TODO make this reset on save-->
      <app-league-selector [isAddPage]="true" (leagueChanged)="onLeagueChanged($event)" #leagueSelector></app-league-selector>
      <ion-item [id]="patternId()" button [disabled]="storageService.allPatterns().length === 0">
        <ion-label>Patterns</ion-label>
        <span class="ion-text-right">{{ game().patterns.join(", ") || "None" }}</span>
      </ion-item>
      <ion-modal [presentingElement]="presentingElement" [trigger]="patternId()">
        <ng-template>
          <app-generic-typeahead
            [items]="storageService.allPatterns()"
            [config]="patternTypeaheadConfig"
            [prevSelectedItems]="game().patterns"
            (selectedItemsChange)="onPatternChanged($event)">
          </app-generic-typeahead>
        </ng-template>
      </ion-modal>
      <ion-item
        [id]="'ball-selector-' + patternId()"
        button
        detailIcon="chevron-expand-outline"
        [disabled]="storageService.arsenal().length === 0"
        (click)="openBallModal()">
        <ion-label>Balls</ion-label>
        <span class="ion-text-right">{{ getSelectedBallsText() }}</span>
      </ion-item>
      <ion-modal #modal trigger="ball-selector-{{ patternId() }}" class="ball-modal">
        <ng-template>
          <ion-header>
            <ion-toolbar>
              <ion-title>Select Balls</ion-title>
            </ion-toolbar>
          </ion-header>
          <ion-content>
            <ion-list>
              @for (ball of storageService.arsenal(); track $index) {
                <ion-item (click)="toggleBallSelection(ball.ball_name)">
                  <ion-avatar slot="start">
                    <ion-img [src]="storageService.url + ball.thumbnail_image"></ion-img>
                  </ion-avatar>
                  <ion-label>
                    <h2>{{ ball.ball_name }}</h2>
                    <p>{{ ball.brand_name }} ({{ ball.release_date }})</p>
                  </ion-label>
                  <ion-checkbox slot="end" [checked]="isBallSelected(ball.ball_name)" (ionChange)="$event.stopPropagation()"></ion-checkbox>
                </ion-item>
              }</ion-list
          ></ion-content>
          <ion-footer>
            <ion-toolbar>
              <ion-buttons slot="end" class="modal-buttons">
                <ion-button (click)="cancelBallSelection(modal)" fill="clear" class="modal-button cancel-button">Cancel</ion-button>
                <ion-button (click)="confirmBallSelection(modal)" fill="clear" class="modal-button ok-button">Ok</ion-button>
              </ion-buttons>
            </ion-toolbar>
          </ion-footer>
        </ng-template>
      </ion-modal>
      <!-- <ion-popover [trigger]="'ball-selector-' + patternId()" size="auto" [dismissOnSelect]="false">
        <ng-template>
          <ion-content class="ion-padding">
            <ion-list>
              <ion-item *ngFor="let ball of storageService.arsenal()" button (click)="toggleBallSelection(ball.ball_name)">
                <ion-avatar slot="start">
                  <ion-img [src]="storageService.url + ball.thumbnail_image"></ion-img>
                </ion-avatar>
                <ion-label>
                  <h2>{{ ball.ball_name }}</h2>
                  <p>{{ ball.brand_name }} ({{ ball.release_date }})</p>
                </ion-label>
                <ion-checkbox slot="end" [checked]="isBallSelected(ball.ball_name)" (ionChange)="$event.stopPropagation()"></ion-checkbox>
              </ion-item>
            </ion-list>
          </ion-content>
        </ng-template>
      </ion-popover> -->
      <ion-item lines="none">
        <ion-textarea
          label="Note"
          type="text"
          [(ngModel)]="game().note"
          name="note"
          [autoGrow]="true"
          placeholder="today knee pain, lanes dry af, i fucking suck today"></ion-textarea>
      </ion-item>
    </ion-list>
  </div>
}
